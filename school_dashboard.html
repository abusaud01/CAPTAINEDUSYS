<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لوحة تحكم المدرسة - نظام الكابتن</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        /* نفس الـ CSS بدون تغيير */
    </style>
</head>
<body>
    <!-- نفس الـ HTML بدون تغيير -->

    <script>
        const supabaseUrl = 'https://ekbiivktykhebsqmllsx.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVrYmlpdmt0eWtoZWJzcW1sbHN4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI0NTk1MzIsImV4cCI6MjA3ODAzNTUzMn0.sVd_UV3JPgzmkdAmVCOZJfyD7ZrIaXIOPOv7cHo8AI8';
        const _supabase = supabase.createClient(supabaseUrl, supabaseKey );

        const params = new URLSearchParams(window.location.search);
        const schoolId = params.get('id');
        const schoolNameHeader = document.getElementById('schoolNameHeader');
        const addAgentBtn = document.getElementById('add-agent-btn');
        const agentsTableBody = document.getElementById('agents-table-body');
        
        async function loadSchoolData() {
            // ... نفس الكود
            await loadAgents();
        }

        // --- التحديث الجذري هنا ---
        async function loadAgents() {
            // استعلام مباشر وبسيط جدًا من جدول الوكلاء
            const { data, error } = await _supabase
                .from('agents')
                .select('full_name, email')
                .eq('school_id', schoolId);

            if (error) {
                console.error('Error fetching agents:', error);
                agentsTableBody.innerHTML = `<tr><td colspan="2" class="no-data">حدث خطأ: ${error.message}</td></tr>`;
                return;
            }
            
            agentsTableBody.innerHTML = '';
            if (data.length === 0) {
                agentsTableBody.innerHTML = '<tr><td colspan="2" class="no-data">لا يوجد وكلاء مضافون لهذه المدرسة بعد.</td></tr>';
                return;
            }
            
            data.forEach(agent => {
                agentsTableBody.innerHTML += `<tr><td>${agent.full_name}</td><td>${agent.email || '-'}</td></tr>`;
            });
        }

        addAgentBtn.addEventListener('click', async () => {
            // ... نفس كود Swal.fire
            
            if (formValues) {
                const [fullName, email, password] = formValues;
                // ... نفس كود التحقق

                // 1. إنشاء المستخدم في auth.users
                const { data: signUpData, error: signUpError } = await _supabase.auth.signUp({ email, password });
                if (signUpError) {
                    // ... نفس كود معالجة الخطأ
                    return;
                }

                // 2. ربط المستخدم وتخزين البريد الإلكتروني مباشرة
                const newUserId = signUpData.user.id;
                const { error: agentInsertError } = await _supabase
                    .from('agents')
                    // --- التحديث الجذري هنا ---
                    .insert([{ 
                        user_id: newUserId, 
                        school_id: schoolId, 
                        full_name: fullName,
                        email: email // تخزين البريد الإلكتروني مباشرة
                    }]);

                if (agentInsertError) {
                    // ... نفس كود معالجة الخطأ
                } else {
                    Swal.fire('تم!', 'تمت إضافة الوكيل بنجاح.', 'success');
                    await loadAgents();
                }
            }
        });
        // --- نهاية التحديث الجذري ---

        // ... بقية الكود (Tab switching, DOMContentLoaded)
    </script>
</body>
</html>
