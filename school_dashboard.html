<!DOCTYPE html>
<!-- الإصدار الذهبي النهائي v25.0 - school_dashboard.html -->
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لوحة التحكم - نظام الكابتن</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        /* نفس الـ CSS من الإصدار السابق */
        :root { --royal-green: #004225; --gold-accent: #FFD700; --light-cream: #F5F5DC; --dark-charcoal: #333333; --white: #FFFFFF; --light-gray: #f8f9fa; --gray-border: #dee2e6; }
        body { font-family: 'Tajawal', sans-serif; background-color: var(--light-cream ); margin: 0; color: var(--dark-charcoal); }
        .container { max-width: 1200px; margin: 20px auto; padding: 20px; }
        .header { background-color: var(--royal-green); color: var(--white); padding: 20px; border-radius: 10px; margin-bottom: 30px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .header h1 { margin: 0; }
        .section { background-color: var(--white); padding: 25px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 30px; }
        .section h2 { margin-top: 0; color: var(--royal-green); border-bottom: 2px solid var(--gold-accent); padding-bottom: 10px; margin-bottom: 20px; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; }
        .form-group { display: flex; flex-direction: column; }
        .form-group label { margin-bottom: 8px; font-weight: 500; }
        .form-group input { padding: 12px; border: 1px solid var(--gray-border); border-radius: 8px; font-family: 'Tajawal', sans-serif; font-size: 16px; }
        .btn { background-color: var(--royal-green); color: var(--white); border: none; padding: 12px 25px; border-radius: 8px; cursor: pointer; font-family: 'Tajawal', sans-serif; font-size: 1em; font-weight: 700; transition: background-color 0.3s; }
        .btn:hover { background-color: #005a34; }
        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 15px; text-align: right; border-bottom: 1px solid var(--gray-border); }
        th { background-color: var(--light-gray); }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 id="schoolNameHeader">لوحة التحكم الخاصة بمدرسة: ...</h1>
        </div>
        <div class="section">
            <h2>إضافة وكيل جديد</h2>
            <form id="addAgentForm">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="agentName">اسم الوكيل الكامل</label>
                        <input type="text" id="agentName" required>
                    </div>
                    <div class="form-group">
                        <label for="agentEmail">البريد الإلكتروني</label>
                        <input type="email" id="agentEmail" required>
                    </div>
                    <div class="form-group">
                        <label for="agentPassword">كلمة المرور</label>
                        <input type="password" id="agentPassword" required>
                    </div>
                </div>
                <button type="submit" class="btn" style="margin-top: 20px;">إضافة الوكيل</button>
            </form>
        </div>
        <div class="section">
            <h2>قائمة الوكلاء</h2>
            <div class="table-container">
                <table id="agentsTable">
                    <thead><tr><th>الاسم</th><th>البريد الإلكتروني</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        const supabaseUrl = 'https://xpeubmofhyoqupsjfalq.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhwZXVibW9maHlvcXVwc2pmYWxxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIyNTM3NzgsImV4cCI6MjA3NzgyOTc3OH0.A7zvw6etTDGe-WhWCisvtYcxy_JANWSBW1r3XOh2LVA';
        const _supabase = supabase.createClient(supabaseUrl, supabaseKey );

        const params = new URLSearchParams(window.location.search);
        const schoolId = params.get('id');

        // --- دالة استدعاء دالة الحافة الجديدة ---
        async function createAgentViaFunction(email, password, fullName, currentSchoolId) {
            const { data, error } = await _supabase.functions.invoke('create-agent', {
                body: { email, password, fullName, schoolId: currentSchoolId },
            });

            if (error) {
                console.error('Error invoking edge function:', error);
                Swal.fire('فشل استدعاء الدالة', `لم يتم إنشاء الوكيل. السبب: ${error.message}`, 'error');
                return;
            }
            
            if (data.error) {
                 console.error('Error from inside edge function:', data.error);
                 Swal.fire('فشل إنشاء الوكيل', `فشل إنشاء الوكيل. السبب: ${data.error}`, 'error');
                 return;
            }

            console.log('Function executed successfully:', data.message);
            Swal.fire('نجاح!', 'تم إنشاء الوكيل وربطه بالمدرسة بنجاح.', 'success').then(() => {
                location.reload();
            });
        }

        // --- ربط النموذج بالدالة الجديدة ---
        document.getElementById('addAgentForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const agentName = document.getElementById('agentName').value;
            const agentEmail = document.getElementById('agentEmail').value;
            const agentPassword = document.getElementById('agentPassword').value;
            createAgentViaFunction(agentEmail, agentPassword, agentName, schoolId);
        });

        // --- بقية الدوال (loadAgents, loadSchoolDetails) تبقى كما هي ---
        async function loadAgents() {
            if (!schoolId) return;
            const { data: agents, error } = await _supabase.from('agents').select('name, email').eq('school_id', schoolId);
            if (error) { console.error('Error fetching agents:', error); return; }
            const agentsTableBody = document.querySelector('#agentsTable tbody');
            agentsTableBody.innerHTML = agents.map(agent => `<tr><td>${agent.name}</td><td>${agent.email}</td></tr>`).join('');
        }
        async function loadSchoolDetails() {
            if (!schoolId) { document.body.innerHTML = '<h1>خطأ: لم يتم تحديد المدرسة.</h1>'; return; }
            const { data: school } = await _supabase.from('schools').select('name').eq('id', schoolId).single();
            if (school) { document.getElementById('schoolNameHeader').textContent = `لوحة التحكم الخاصة بمدرسة: ${school.name}`; }
        }
        document.addEventListener('DOMContentLoaded', () => { loadSchoolDetails(); loadAgents(); });
    </script>
</body>
</html>
